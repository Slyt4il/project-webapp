{% extends 'base.html' %}

{% block titlebar %}
Twitta - Twitter without the E.
{% endblock titlebar %}

{% block content %}
Welcome to Twitta - Twitter without the E.

<div>
    <br>
    <p>QUICK LINKS - REMOVE THIS</p>
    <a href='login'>Login</a>
    <a href='register'>Register</a>
    <a href='profile'>Profile</a>
    <a href='twittit'>Form</a>
    <a href='admin\'>Admin</a>
</div>

<div class='row'>
    <div class='col-md-4 mx-auto col-10'>
        <form class='form' id='twitt-create-form' method='POST' action='/twittit'>
                {% csrf_token %}
            <div class='d-none alert alert-danger' id='twitt-create-error'></div>
            <input type='hidden' value='/' name='next' />
            <textarea required='required' class='form-control' name='content' placeholder='Say something to the world...!'></textarea>
            <button class='btn btn-primary' style="float: right;" >Twitt'it</button>
        </form>
    </div>
</div>

<div id='twitts'>
    Bringing you the freshest news without the censorship... (Cuz we can't afford to moderate our platform.)
</div>

<script>

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function handleTwittFormError(message, display) {
        var errorDiv = document.getElementById('twitt-create-error')
        if (display === true) {
            errorDiv.setAttribute('class', 'd-block alert alert-danger')
            errorDiv.innerHTML = message
        } else {
            errorDiv.setAttribute('class', 'd-none alert alert-danger')
        }
    }

    function twittCreateFormSubmission(event) {
        event.preventDefault()
        const thisForm = event.target
        const thisFormData = new FormData(thisForm)
        const endpoint = thisForm.getAttribute('action')
        const method = thisForm.getAttribute('method')
        const xhr = new XMLHttpRequest()
        xhr.responseType = 'json'
        xhr.open(method, endpoint)
        xhr.setRequestHeader('HTTP_X_REQUESTED_WITH', 'XMLHttpRequest')
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
        xhr.onload = function() {
            if (xhr.status === 201)
            {
                const formattedTwitt = prettify(xhr.response)
                console.log(formattedTwitt)
                const originalHTML = twittsElementInDoc.innerHTML
                twittsElementInDoc.innerHTML = formattedTwitt + originalHTML
                thisForm.reset()
            } else if (xhr.status === 400) {
                const errorResponse = xhr.response
                let contentErrorMessage
                if (errorResponse.content) {
                    contentErrorMessage = errorResponse.content[0]
                    if (contentErrorMessage) {
                        handleTwittFormError(contentErrorMessage, true)
                    } else {
                        alert('An error occured. Please try again later.')
                    }
                } else {
                    alert('An error occured. Please try again later.')
                }
                console.log(contentErrorMessage)

            } else if (xhr.status == 401) {
                alert('You must be logged in to continue.')
                window.location.href = "/login"
            } else if (xhr.status == 403) {
                alert('You must be logged in to continue.')
                window.location.href = "/login"
            } 
            else if (xhr.status == 500) {
                alert('An error occured on the server.')
            }
        }
        xhr.onerror = function() {
            alert('A fatal error occured. Please try again later.')
        }
        xhr.send(thisFormData)
    }

    const twittCreateFormElementInDoc = document.getElementById('twitt-create-form')

    twittCreateFormElementInDoc.addEventListener("submit", twittCreateFormSubmission)


    const twittsElementInDoc = document.getElementById('twitts')

    function loadTwitts(twittsElement) {
        const xhr = new XMLHttpRequest()
        const method = 'GET'
        const url = '/twitts'
        const responseType = 'json'
        xhr.responseType = responseType
        xhr.open(method, url)
        xhr.onload = function() {
            const listedItems = xhr.response
            var str = ""
            for (var i = listedItems.length-1; i >= 0; i--) {
                var currentItem = prettify(listedItems[i])
                str += currentItem
        }
        twittsElement.innerHTML = str
        }
        xhr.send()
    }

    loadTwitts(twittsElementInDoc)

    function LikeBtn(twitt) {
        return "<button class='btn btn-primary btn-sm' onclick=onLike(" + twitt.id + "," + twitt.likes + ")>" + twitt.likes + " Likes</button>"
    }

    function onLike(twitt_id, currentLikes) {
        const url = "/api/twitts/action"
        const method = "POST"
        const data = JSON.stringify({
            id : twitt_id,
            action : 'like'
        })
        const xhr = new XMLHttpRequest()
        xhr.open(method, url)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.setRequestHeader('HTTP_X_REQUESTED_WITH', 'XMLHttpRequest')
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
        xhr.setRequestHeader('X-CSRFToken', csrftoken)
        xhr.onload = function() {
            loadTwitts(twittsElementInDoc)
        }
        xhr.send(data)

        return
    }

    function prettify(twitt) {
        var formatted = "<div>ID : " + twitt.id + " " + twitt.content + "</div><div class='btn-group'>" + LikeBtn(twitt) + "</div>" + "<p>" + twitt.timestamp + "</p>"
        return formatted
    }
</script>
{% endblock content %}